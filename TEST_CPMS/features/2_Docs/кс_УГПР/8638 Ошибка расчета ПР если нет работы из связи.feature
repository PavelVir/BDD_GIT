#language: ru

@tree

#report.epic=Документы 
#report.feature=Частные задачи
#report.story=8638 Ошибка расчета ПР если нет работы из связи


Функционал: #8638 Ошибка расчета ПР если нет работы из связи

Как пользователь я хочу
иметь возможность выбрать из дерева проекта работу или группу работ
чтобы удобно заполнять аналитки в документах


Контекст: 

	Дано я подключаю TestClient "Полные права УСП" логин "Tester_FullA" пароль ""
	И я закрыл все окна клиентского приложения

	
Сценарий: Я создаю тестовые данные для проверки расчета 8638

		Дано Я устанавливаю в константу "ИспользоватьПроекты" значение "Истина"
		И я проверяю или создаю для справочника "Валюты" объекты:
		| 'Ссылка'                                                               | 'DeletionMark' | 'Код'  | 'Наименование' | 'ЗагружаетсяИзИнтернета' | 'НаименованиеПолное' | 'Наценка' | 'ОсновнаяВалюта' | 'ПараметрыПрописиНаРусском'                                 | 'ПараметрыПрописиНаУкраинском'                                | 'ФормулаРасчетаКурса' | 'СпособУстановкиКурса'                        |
		| 'e1cib/data/Справочник.Валюты?ref=80e3000c29e0e9f611ea0bd98b14b7b8' | 'False'        | '8469'  | 'UAH'          | 'False'                  | 'гривня'             | '0'       | ''               | 'гривна, гривны, гривен, ж, копейка, копейки, копеек, ж, 2' | 'гривня, гривні, гривень, ж, копійка, копійки, копійок, ж, 2' | ''                    | 'Enum.СпособыУстановкиКурсаВалюты.РучнойВвод' |			
		И я проверяю или создаю для справочника "кс_ЕдиницыИзмеренияСмета" объекты:
		| 'Ссылка'                                                                                 | 'DeletionMark' | 'Код'  | 'Наименование' |
		| 'e1cib/data/Справочник.кс_ЕдиницыИзмеренияСмета?ref=80e3000c29e0e9f611ea11b8eab3b140' | 'False'        | '000'  | '100м3'        |
		И я проверяю или создаю для справочника "Проекты" объекты:
		| 'Ссылка'                                                             | 'DeletionMark' | 'Родитель' | 'IsFolder' | 'Наименование' | 'ПлановаяДатаНачала' | 'Договор' | 'ДатаНачала'         | 'ПлановаяДатаОкончания' | 'Контрагент' | 'кс_БизнесРегион' | 'кс_ВидПроекта' | 'кс_ВыгружатьВПанельРуководителя' | 'кс_МетодикаРасчета' | 'кс_Организация' | 'кс_ОрганизацияРегл' | 'кс_ПолноеНаименование' | 'кс_ПроизвольнаяСтруктураWBS' |
		| 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'False'        | ''         | 'False'    | 'Проект 8638'  | '01.01.0001 0:00:00' | ''        | '01.01.0001 0:00:00' | '01.01.0001 0:00:00'    | ''           | ''                | ''              | 'False'                           | ''                   | ''               | ''                   | ''                      | 'True'                        |
		И я проверяю или создаю для справочника "кс_Версия" объекты:
		| 'Ссылка'                                                                  | 'DeletionMark' | 'Владелец'                                                           | 'Наименование' | 'ВидВерсии'                 | 'ДатаСоздания'       | 'Активная' | 'НомерВерсии' |
		| 'e1cib/data/Справочник.кс_Версия?ref=10d6000c298f8d8711eb9df67e503695' | 'False'        | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Рабочая'      | 'Enum.кс_ВидВерсии.Рабочая' | '15.04.2021 0:00:00' | 'True'     | '1'           |
		И я проверяю или создаю для справочника "Организации" объекты:
		| 'Ссылка'                                                                    | 'DeletionMark' | 'Наименование'   | 'ДатаРегистрации'    | 'НаименованиеПолное'                                  | 'НаименованиеСокращенное' | 'ОбособленноеПодразделение' | 'Префикс' | 'ЮрФизЛицо'             | 'ЮридическоеФизическоеЛицо'                      | 'КодПоЕДРПОУ' | 'КодКВЕД' |
		| 'e1cib/data/Справочник.Организации?ref=80e3000c29e0e9f611ea1135ddf132f1' | 'False'        | 'АЕС-ГРУПП ТОВ' | '21.05.2012 0:00:00' | 'Товариство з обмеженою відповідальністю "АЕС-ГРУПП"' | 'ТОВ "АЕС-ГРУПП"'         | 'False'                     | 'АЕ'      | 'Enum.ЮрФизЛицо.ЮрЛицо' | 'Enum.ЮридическоеФизическоеЛицо.ЮридическоеЛицо' | '38202783'    | '41.10'   |
		И я проверяю или создаю для справочника "кс_КонструктивыПроекта" объекты:
		| 'Ссылка'                                                                               | 'DeletionMark' | 'Владелец'                                                              | 'Наименование'         | 'УровеньСметы' | 'ОбъектПроекта'                                                                          | 'ЭлементОбъекта'                                                                     | 'ЭлементОбъекта2'                                                                     | 'Конструктив'                                                                | 'ПодКонструктив'                                                               | 'ПодКонструктив2'                                                               | 'Комментарий' | 'АльбомПроектов' | 'НаименованиеАнгл' | 'ШаблонWBS' | 'ГлаваССРС' | 'Раздел' | 'СметноеНаименование' | 'КлючСтроки'                           | 'ДополнениеКНаименованию' | 'НаименованиеПолное' |
		| 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4c1' | 'False'        | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Строительный объект' | ''             | 'e1cib/data/Справочник.кс_СтроительныеОбъектыКласс?ref=80d6000c298f8d8711ebb23bff0ed4c8' | ''                                                                                   | ''                                                                                    | ''                                                                           | ''                                                                             | ''                                                                              | ''            | ''               | ''                 | ''          | ''          | ''       | 'Строительный объект' | 'b2f4cd27-12a4-472a-9b84-b269147bd909' | ''                        | ''                   |
		| 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4c1' | 'False'        | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Элемент 1 уровня'    | ''             | ''                                                                                       | 'e1cib/data/Справочник.кс_ЭлементыОбъектовКлас?ref=80d6000c298f8d8711ebb23bff0ed4cb' | ''                                                                                    | ''                                                                           | ''                                                                             | ''                                                                              | ''            | ''               | ''                 | ''          | ''          | ''       | ''                    | '14b1776b-cdad-45b5-b697-46df9d8050c6' | ''                        | ''                   |
		| 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d1' | 'False'        | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Элемент 2 уровня'    | ''             | ''                                                                                       | ''                                                                                   | 'e1cib/data/Справочник.кс_ЭлементыОбъектовКлас2?ref=80d6000c298f8d8711ebb23bff0ed4ce' | ''                                                                           | ''                                                                             | ''                                                                              | ''            | ''               | ''                 | ''          | ''          | ''       | 'Элемент 2 уровня'    | '13556753-8439-4f1b-bb1d-024ca8d3f2cd' | ''                        | ''                   |
		| 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d2' | 'False'        | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Конструктив'         | ''             | ''                                                                                       | ''                                                                                   | ''                                                                                    | 'e1cib/data/Справочник.кс_Конструктивы?ref=80d6000c298f8d8711ebb23bff0ed4d3' | ''                                                                             | ''                                                                              | ''            | ''               | ''                 | ''          | ''          | ''       | ''                    | '62621d5e-ef5f-4b61-98e1-b8db71dec607' | ''                        | ''                   |
		| 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d3' | 'False'        | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Подконструктив'      | ''             | ''                                                                                       | ''                                                                                   | ''                                                                                    | ''                                                                           | 'e1cib/data/Справочник.кс_ПодКонструктив?ref=80d6000c298f8d8711ebb23bff0ed4d6' | ''                                                                              | ''            | ''               | ''                 | ''          | ''          | ''       | ''                    | '5763d11b-962a-4b36-9880-24b27a52b129' | ''                        | ''                   |
		| 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d4' | 'False'        | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Подконструктив 2'    | ''             | ''                                                                                       | ''                                                                                   | ''                                                                                    | ''                                                                           | ''                                                                             | 'e1cib/data/Справочник.кс_ПодКонструктив2?ref=80d6000c298f8d8711ebb23bff0ed4d9' | ''            | ''               | ''                 | ''          | ''          | ''       | ''                    | '61caec5e-d402-44a2-9b63-deefe68fb1fa' | ''                        | ''                   |
		И я проверяю или создаю для справочника "кс_ВидыРаботПроект" объекты:
 		| 'Ссылка'                                                                        | 'Владелец'                                                           | 'Наименование'                       | 'ВидРабот' | 'ОсновнаяЕдиница'                                                                     | 'ШифрПозицииНорматива' | 'НаименованиеПолное'                 | 'ИзмененоНазвание' | 'НаименованиеАнгл' | 'СчетБУ' | 'Демонтаж' | 'ДополнениеКНаименованию' | 'КлючСтроки'                           |
 		| 'e1cib/data/Справочник.кс_ВидыРаботПроект?ref=80d6000c298f8d8711ebb23bff0ed4dd' | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'Произвольная работа (без сборника)' | ''         | 'e1cib/data/Справочник.кс_ЕдиницыИзмеренияСмета?ref=80e3000c29e0e9f611ea11b8eab3b140' | '0'                    | 'Произвольная работа (без сборника)' | 'True'             | ''                 | ''       | 'False'    | ''                        | '0a920c9d-d3d3-4f52-996d-e49847bd69bc' |
		И я проверяю или создаю для документа "кс_УГПР" объекты:
		| 'Ссылка'                                                           | 'Дата'                | 'Проведен' | 'Проект'                                                             | 'Организация'                                                            | 'Ответственный'                                                           | 'Версия'                                                               | 'Комментарий' | 'НДС' | 'СметнаяПрибыль' | 'Статус'                         | 'СтоимостьЗаказчикаСебестоимость' | 'Создатель'                                                               | 'Шаблон' | 'ИсточникСозданияСметы'                         | 'ДатаОбновленияЦен'  | 'СуммаДокумента' |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | '11.05.2021 12:33:06' | 'True'     | 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'e1cib/data/Справочник.Организации?ref=80e3000c29e0e9f611ea1135ddf132f1' | 'e1cib/data/Справочник.Пользователи?ref=88fdf0826edc46f04494ad84aa00559e' | 'e1cib/data/Справочник.кс_Версия?ref=10d6000c298f8d8711eb9df67e503695' | ''            | '0'   | '0'              | 'Enum.СтатусыПланов.ВПодготовке' | 'False'                           | 'e1cib/data/Справочник.Пользователи?ref=88fdf0826edc46f04494ad84aa00559e' | 'False'  | 'Enum.кс_ИсточникСозданияСметы.Непосредственно' | '01.01.0001 0:00:00' | '0'              |
		И я перезаполняю для объекта табличную часть "Работы":
		| 'Ссылка'                                                           | 'КлючСтроки'                           | 'КлючСвязи'                            | 'НомерВСтруктуре' | 'ВидРаботы'                                                                         | 'ЕдиницаИзмерения'                                                                    | 'Объем' | 'ЭтоРабота' |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | 'b2f4cd27-12a4-472a-9b84-b269147bd909' | '00000000-0000-0000-0000-000000000000' | '0000000001'      | 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4c1' | ''                                                                                    | '0'     | 'False'     |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | '14b1776b-cdad-45b5-b697-46df9d8050c6' | 'b2f4cd27-12a4-472a-9b84-b269147bd909' | '0000000002'      | 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4c1' | ''                                                                                    | '0'     | 'False'     |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | '13556753-8439-4f1b-bb1d-024ca8d3f2cd' | '14b1776b-cdad-45b5-b697-46df9d8050c6' | '0000000003'      | 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d1' | ''                                                                                    | '0'     | 'False'     |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | '62621d5e-ef5f-4b61-98e1-b8db71dec607' | '13556753-8439-4f1b-bb1d-024ca8d3f2cd' | '0000000004'      | 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d2' | ''                                                                                    | '0'     | 'False'     |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | '5763d11b-962a-4b36-9880-24b27a52b129' | '62621d5e-ef5f-4b61-98e1-b8db71dec607' | '0000000005'      | 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d3' | ''                                                                                    | '0'     | 'False'     |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | '61caec5e-d402-44a2-9b63-deefe68fb1fa' | '5763d11b-962a-4b36-9880-24b27a52b129' | '0000000006'      | 'e1cib/data/Справочник.кс_КонструктивыПроекта?ref=80d6000c298f8d8711ebb23bff0ed4d4' | ''                                                                                    | '0'     | 'False'     |
		| 'e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de' | '0a920c9d-d3d3-4f52-996d-e49847bd69bc' | '61caec5e-d402-44a2-9b63-deefe68fb1fa' | '0000000007'      | 'e1cib/data/Справочник.кс_ВидыРаботПроект?ref=80d6000c298f8d8711ebb23bff0ed4dd'     | 'e1cib/data/Справочник.кс_ЕдиницыИзмеренияСмета?ref=80e3000c29e0e9f611ea11b8eab3b140' | '500'   | 'True'      |

		И я проверяю или создаю для регистра сведений "кс_ВзаимосвязиРабот" записи:
		| 'Проект'                                                             | 'Версия'                                                               | 'КлючСтрокиА'                          | 'КлючСтрокиБ' | 'Запаздывание' | 'ТипСвязи'                                | 'ВидРаботыА'                                                                    | 'ВидРаботыБ' | 'НомерСтрокиА' | 'НомерСтрокиБ' | 'АктуальнаяСвязь' |
		| 'e1cib/data/Справочник.Проекты?ref=00000000000000000000000041355e01' | 'e1cib/data/Справочник.кс_Версия?ref=10d6000c298f8d8711eb9df67e503695' | '0a920c9d-d3d3-4f52-996d-e49847bd69bc' | '123'         | '0'            | 'Enum.кс_ТипыСвязейРабот.ОкончаниеНачало' | 'e1cib/data/Справочник.кс_ВидыРаботПроект?ref=80d6000c298f8d8711ebb23bff0ed4dd' | ''           | '7'            | '0'            | 'True'            |
 
Сценарий: Я проверяю расчет Кп если связь указывает на несущестующую работу
	Дано Я открываю навигационную ссылку "e1cib/data/Документ.кс_УГПР?ref=00d6000c298f8d8711ebb23bff0ed4de"
	Если появилось предупреждение тогда
		Тогда я вызываю исключение "Не удалось открыть форму ПР"
	Когда открылось окно 'План работ №*'
	И я перехожу к закладке с именем "РаботыДерево"
	И в таблице "ВзаимосвязиРаботПосл" я нажимаю на кнопку с именем 'РаботыДЗОтключитьОтборПоДереву7'
	И я перехожу к закладке с именем "ГруппаВзаимосвязиРабот"
	И я перехожу к закладке с именем "ГруппаПоследователи"
	Тогда таблица "ВзаимосвязиРаботПосл" стала равной:
		| 'Предшествующая работа'              | 'Последующая работа' | 'Запаздывание' | 'Тип связи'             |
		| 'Произвольная работа (без сборника)' | ''                   | ''             | 'Окончание-начало (ОН)' |
	И я перехожу к закладке с именем "СтраницаРасчетПлана"
	И я выбираю пункт контекстного меню с именем 'РаботыДЗВзаимосвязи_РасчетДат1' на элементе формы с именем "ДиаграммаГанта"
	Тогда открылось окно 'Форма расчета дат'
	И я нажимаю на кнопку с именем 'ВыполнитьРасчет'
	Если появилось предупреждение тогда
		Тогда я вызываю исключение "Не удалось выполнить расчет КП в форме ПР"
	Тогда в логе сообщений TestClient есть строки:
		|'Связь с несуществующей в текущем ПР работой 123                                 , проверьте данные связей'|
	И я закрыл все окна клиентского приложения